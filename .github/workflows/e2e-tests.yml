name: E2E Tests

on:
  workflow_call:  # Called by release workflow
  workflow_dispatch:  # Allow manual triggering

concurrency:
  group: ${{ github.workflow || 'E2E Tests' }}-${{ github.ref || github.sha }}
  cancel-in-progress: true

permissions:
  contents: write  # needed for creating test tags

jobs:
  e2e:
    runs-on: ubuntu-latest
    env:
      # Common tag prefix (matrix can override)
      TEST_TAG_PREFIX: ${{ matrix.tagPrefix || 'test-' }}
      # GitHub
      TEST_GITHUB_REPOSITORY: ${{ matrix.githubRepo || secrets.TEST_GITHUB_REPOSITORY || github.repository }}
      TEST_GITHUB_TOKEN: ${{ secrets.TEST_GITHUB_TOKEN || secrets.GITHUB_TOKEN || '' }}
      # Gitea
      TEST_GITEA_REPOSITORY: ${{ matrix.giteaRepo || secrets.TEST_GITEA_REPOSITORY || '' }}
      TEST_GITEA_TOKEN: ${{ secrets.TEST_GITEA_TOKEN || '' }}
      TEST_GITEA_BASE_URL: ${{ matrix.giteaBaseUrl || '' }}
      # Bitbucket
      TEST_BITBUCKET_REPOSITORY: ${{ matrix.bitbucketRepo || secrets.TEST_BITBUCKET_REPOSITORY || '' }}
      TEST_BITBUCKET_TOKEN: ${{ secrets.TEST_BITBUCKET_TOKEN || '' }}
      TEST_BITBUCKET_BASE_URL: ${{ matrix.bitbucketBaseUrl || '' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: github
            testPattern: github.e2e
            githubRepo: LiquidLogicLabs/git-action-release-tests
            tagPrefix: test-
          - platform: gitea
            testPattern: gitea.e2e
            giteaBaseUrl: https://git.ravenwolf.org
            giteaRepo: liquidlogiclabs/git-action-release-tests
            tagPrefix: test-
          # - platform: bitbucket
          #   testPattern: bitbucket.e2e
          #   bitbucketBaseUrl: https://bitbucket.org
          #   bitbucketRepo: owner/repo
          #   tagPrefix: test-
          - platform: generic
            testPattern: generic.e2e
            tagPrefix: test-
          - platform: git
            testPattern: generic.e2e
            tagPrefix: test-

    environment: TEST

    permissions:
      contents: write
      actions: read
    # Run action from committed dist only (no build). Ensures E2E fails if dist is unbundled.
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare tag metadata
        id: prep
        run: |
          TAG_NAME="${{ matrix.tagPrefix || 'test-' }}$(date +%s)-${GITHUB_SHA:0:7}-${{ matrix.platform }}"
          echo "tag-name=$TAG_NAME" >> "$GITHUB_OUTPUT"

      - name: Resolve platform inputs
        id: resolve
        run: |
          set -euo pipefail
          run="true"
          repo=""
          token=""
          base_url=""
          push_tag="true"
          case "${{ matrix.platform }}" in
            github)
              repo="${TEST_GITHUB_REPOSITORY}"
              token="${TEST_GITHUB_TOKEN}"
              push_tag="true"
              if [ -z "$repo" ] || [ -z "$token" ]; then
                echo "⚠️ Skipping GitHub E2E: repo or token missing"
                run="false"
              fi
              ;;
            gitea)
              repo="${TEST_GITEA_REPOSITORY}"
              token="${TEST_GITEA_TOKEN}"
              base_url="${TEST_GITEA_BASE_URL}"
              push_tag="true"
              if [ -z "$repo" ] || [ -z "$token" ]; then
                echo "⚠️ Skipping Gitea E2E: repo or token missing"
                run="false"
              fi
              ;;
            bitbucket)
              repo="${TEST_BITBUCKET_REPOSITORY}"
              token="${TEST_BITBUCKET_TOKEN}"
              base_url="${TEST_BITBUCKET_BASE_URL}"
              push_tag="true"
              if [ -z "$repo" ] || [ -z "$token" ]; then
                echo "⚠️ Skipping Bitbucket E2E: repo or token missing"
                run="false"
              fi
              ;;
            generic|git)
              push_tag="false"
              run="true"
              ;;
          esac
          echo "run=$run" >> "$GITHUB_OUTPUT"
          echo "repo=$repo" >> "$GITHUB_OUTPUT"
          echo "token=$token" >> "$GITHUB_OUTPUT"
          echo "base_url=$base_url" >> "$GITHUB_OUTPUT"
          echo "push_tag=$push_tag" >> "$GITHUB_OUTPUT"

      - name: Configure Git user (for git/generic platform)
        if: steps.resolve.outputs.run == 'true' && (matrix.platform == 'git' || matrix.platform == 'generic')
        run: |
          # Configure git user for annotated tags (required by Git)
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          echo "✅ Configured git user for local Git operations"

      - name: Run E2E via action (${{ matrix.platform }})
        if: steps.resolve.outputs.run == 'true'
        uses: ./
        with:
          tag-name: ${{ steps.prep.outputs.tag-name }}
          tag-message: E2E ${{ matrix.platform }} tag ${{ steps.prep.outputs.tag-name }}
          repository: ${{ steps.resolve.outputs.repo }}
          token: ${{ steps.resolve.outputs.token }}
          base-url: ${{ steps.resolve.outputs.base_url }}
          repo-type: ${{ matrix.platform }}
          force: true
          update-existing: false
          push-tag: ${{ steps.resolve.outputs.push_tag }}
          verbose: true
